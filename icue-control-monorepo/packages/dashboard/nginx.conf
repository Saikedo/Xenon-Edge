server {
    listen 80;
    server_name localhost;

    # Force HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name localhost;

    ssl_certificate /etc/nginx/certs/cert.pem;
    ssl_certificate_key /etc/nginx/certs/key.pem;

    root /usr/share/nginx/html;
    index index.html;

    # 1. Serve React App (SPA Support)
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 2. Proxy API to Windows Agent (192.168.68.79:4000)
    location /api/ {
        proxy_pass http://192.168.68.79:4000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }


}

# Dedicated Server for Beszel (Port 8443)
# Allows proxying from root / to avoid path issues
server {
    listen 9443 ssl;
    server_name localhost;

    ssl_certificate /etc/nginx/certs/cert.pem;
    ssl_certificate_key /etc/nginx/certs/key.pem;

    location / {
        # Proxy to Beszel (Correct IP)
        proxy_pass http://192.168.68.86:8090/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        
        # Strip Security Headers
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;
        proxy_hide_header Frame-Options;

        # Inject Custom CSS to hide header/div
        sub_filter '</head>' '<style> div[class="flex items-center h-14 md:h-16 bg-card px-4 pe-3 sm:px-6 border border-border/60 bt-0 rounded-md my-4"] { display: none !important; } </style></head>';
        sub_filter_once on;


        # Add Permissive Security Headers for Embedding
        add_header Content-Security-Policy "frame-ancestors 'self' https://$host https://$server_name *;" always;
        
        # WebSocket Support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }
}
