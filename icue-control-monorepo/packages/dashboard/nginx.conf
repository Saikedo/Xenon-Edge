server {
    listen 80;
    server_name localhost;

    # Force HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name localhost;

    ssl_certificate /etc/nginx/certs/cert.pem;
    ssl_certificate_key /etc/nginx/certs/key.pem;

    root /usr/share/nginx/html;
    index index.html;

    # 1. Serve React App (SPA Support)
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 2. Proxy API to Windows Agent (192.168.68.82:4000)
    location /api/ {
        proxy_pass http://192.168.68.82:4000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 3. Proxy Beszel (Strip Headers)
    location /beszel/ {
        proxy_pass http://192.168.68.86:8090/;
        proxy_set_header Host $host;
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;
        proxy_hide_header Frame-Options;
    }

    location /assets/ {
        # Try finding the file locally first (Dashboard assets)
        # If not found, proxy to Beszel
        try_files $uri @beszel_assets;
        # Disable cache for index.html so updates are immediate
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }

    location @beszel_assets {
        # Proxy to Beszel (root) because $uri already includes /assets/
        proxy_pass http://192.168.68.86:8090; 
        proxy_set_header Host $host;
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;
    }

    location /static/ {
        proxy_pass http://192.168.68.86:8090/static/;
        proxy_set_header Host $host;
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;
    }

    # Proxy Beszel API (PocketBase) - Must come BEFORE generic /api/
    location /api/collections/ {
        proxy_pass http://192.168.68.86:8090/api/collections/;
        proxy_set_header Host $host;
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;
    }

    location /api/admins/ {
        proxy_pass http://192.168.68.86:8090/api/admins/;
        proxy_set_header Host $host;
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;
    }

    location /api/health/ {
        proxy_pass http://192.168.68.86:8090/api/health/;
        proxy_set_header Host $host;
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;
    }
}
